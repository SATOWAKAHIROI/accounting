# アーキテクチャ設計書

## 目次

1. [システム概要](#1-システム概要)
2. [システム全体構成図](#2-システム全体構成図)
3. [技術スタック](#3-技術スタック)
4. [フロントエンド構成](#4-フロントエンド構成)
5. [バックエンド構成](#5-バックエンド構成)
6. [データベース構成](#6-データベース構成)
7. [インフラ構成](#7-インフラ構成)
8. [セキュリティ設計](#8-セキュリティ設計)
9. [CI/CD設計](#9-cicd設計)
10. [開発環境](#10-開発環境)

---

## 1. システム概要

### 1-1. システム名
**会計ソフト（Accounting Application）**

### 1-2. 目的
複式簿記に基づいた会計管理システム。仕訳入力、請求書発行、各種会計レポート（総勘定元帳、試算表、損益計算書、貸借対照表）の作成を行う。

### 1-3. 主要機能
- **マスタ管理**: 勘定科目、補助科目、税区分、取引先、品目
- **トランザクション管理**: 仕訳入力、請求書作成、入金登録
- **レポート**: 総勘定元帳、試算表、損益計算書、貸借対照表
- **会計期間管理**: 会計期間の作成、期締め処理
- **認証・認可**: ユーザー登録、ログイン、権限管理（admin/accountant/viewer）
- **マルチテナント**: 複数の会社を管理

### 1-4. 対象ユーザー
- 経理担当者
- 会計士・税理士
- 中小企業の経営者

---

## 2. システム全体構成図

```
┌────────────────────────────────────────────────────────────┐
│                       クライアント                          │
│                    (Webブラウザ)                           │
└───────────────────────┬────────────────────────────────────┘
                        │ HTTPS
                        │
┌───────────────────────┴────────────────────────────────────┐
│                    Heroku Platform                         │
│                                                            │
│  ┌──────────────────────────────────────────────────────┐ │
│  │           フロントエンド (React SPA)                  │ │
│  │  - React 18                                          │ │
│  │  - Tailwind CSS                                      │ │
│  │  - React Router (クライアントサイドルーティング)      │ │
│  │  - Axios (HTTP Client)                               │ │
│  │  - Context API (状態管理)                            │ │
│  └──────────────────┬───────────────────────────────────┘ │
│                     │ REST API (JSON)                    │
│                     │ HTTPS                              │
│  ┌──────────────────┴───────────────────────────────────┐ │
│  │           バックエンド (Spring Boot)                  │ │
│  │  - Spring Boot 2.7.18                                │ │
│  │  - Spring Security (JWT認証)                         │ │
│  │  - Spring Data JPA (ORM)                             │ │
│  │  - Spring Web (REST API)                             │ │
│  │  - Apache PDFBox (PDF生成)                           │ │
│  │  - Apache POI (Excel生成)                            │ │
│  └──────────────────┬───────────────────────────────────┘ │
│                     │ JDBC                               │
│  ┌──────────────────┴───────────────────────────────────┐ │
│  │           データベース (MySQL 8.0)                    │ │
│  │  - 14テーブル (マスタ9、トランザクション5)            │ │
│  │  - InnoDB エンジン                                    │ │
│  │  - UTF-8mb4 文字セット                               │ │
│  └──────────────────────────────────────────────────────┘ │
│                                                            │
└────────────────────────────────────────────────────────────┘

                        ▲
                        │
                        │ Git Push
                        │
┌───────────────────────┴────────────────────────────────────┐
│                    GitHub Repository                       │
│  - ソースコード管理                                         │
│  - GitHub Actions (CI/CD)                                  │
└────────────────────────────────────────────────────────────┘
```

---

## 3. 技術スタック

### 3-1. フロントエンド

| カテゴリ | 技術 | バージョン | 用途 |
|---------|------|-----------|------|
| **フレームワーク** | React | 18.2.0 | UIコンポーネント構築 |
| **ルーティング** | React Router | 6.20.0 | クライアントサイドルーティング |
| **HTTPクライアント** | Axios | 1.6.2 | REST API通信 |
| **状態管理** | Context API + Hooks | - | グローバル状態管理 |
| **UIライブラリ** | Headless UI | 1.7.17 | アクセシブルなUIコンポーネント |
| **アイコン** | Heroicons | 2.1.1 | SVGアイコン |
| **CSSフレームワーク** | Tailwind CSS | 3.3.6 | ユーティリティファーストCSS |
| **ビルドツール** | Vite | 5.0.7 | 高速ビルド・開発サーバー |
| **言語** | JavaScript (ES6+) | - | - |

### 3-2. バックエンド

| カテゴリ | 技術 | バージョン | 用途 |
|---------|------|-----------|------|
| **フレームワーク** | Spring Boot | 2.7.18 | Webアプリケーション基盤 |
| **言語** | Java | 11 | - |
| **セキュリティ** | Spring Security | - | 認証・認可 |
| **ORM** | Spring Data JPA | - | データベースアクセス |
| **バリデーション** | Hibernate Validator | - | 入力検証 |
| **PDF生成** | Apache PDFBox | 2.0.27 | 請求書・レポートPDF生成 |
| **Excel生成** | Apache POI | 5.2.3 | レポートExcel生成 |
| **ビルドツール** | Maven | 3.x | 依存関係管理・ビルド |

### 3-3. データベース

| カテゴリ | 技術 | バージョン | 備考 |
|---------|------|-----------|------|
| **RDBMS** | MySQL | 8.0 | - |
| **ストレージエンジン** | InnoDB | - | トランザクション対応 |
| **文字セット** | UTF-8mb4 | - | 絵文字対応 |

### 3-4. インフラ

| カテゴリ | 技術 | 用途 |
|---------|------|------|
| **ホスティング** | Heroku | アプリケーション・DB・デプロイ |
| **コンテナ** | Docker | ローカル開発環境 |
| **CI/CD** | GitHub Actions | 自動テスト・自動デプロイ |
| **バージョン管理** | Git / GitHub | ソースコード管理 |

---

## 4. フロントエンド構成

### 4-1. ディレクトリ構成

```
frontend/
├── public/
│   └── index.html          # HTMLテンプレート
├── src/
│   ├── main.jsx            # エントリーポイント
│   ├── App.jsx             # ルートコンポーネント
│   ├── components/         # 再利用可能なコンポーネント
│   │   ├── common/         # 共通コンポーネント
│   │   │   ├── Button.jsx
│   │   │   ├── Input.jsx
│   │   │   ├── Modal.jsx
│   │   │   └── Table.jsx
│   │   ├── layout/         # レイアウトコンポーネント
│   │   │   ├── Header.jsx
│   │   │   ├── Sidebar.jsx
│   │   │   └── Footer.jsx
│   │   └── features/       # 機能別コンポーネント
│   │       ├── auth/
│   │       ├── masters/
│   │       ├── journals/
│   │       ├── invoices/
│   │       └── reports/
│   ├── pages/              # ページコンポーネント
│   │   ├── LoginPage.jsx
│   │   ├── DashboardPage.jsx
│   │   ├── AccountsPage.jsx
│   │   └── ...
│   ├── contexts/           # Context API
│   │   ├── AuthContext.jsx
│   │   └── CompanyContext.jsx
│   ├── hooks/              # カスタムフック
│   │   ├── useAuth.js
│   │   └── useApi.js
│   ├── services/           # API通信
│   │   ├── api.js          # Axios設定
│   │   ├── authService.js
│   │   ├── masterService.js
│   │   └── journalService.js
│   ├── utils/              # ユーティリティ関数
│   │   ├── validators.js
│   │   └── formatters.js
│   ├── styles/             # グローバルスタイル
│   │   └── index.css
│   └── routes/             # ルーティング設定
│       └── index.jsx
├── package.json
├── vite.config.js
├── tailwind.config.js
└── postcss.config.cjs
```

### 4-2. 状態管理（Context API）

#### AuthContext
- **役割**: 認証状態の管理
- **状態**:
  - `user`: ログインユーザー情報
  - `isAuthenticated`: 認証状態
  - `accessToken`: JWTトークン
- **メソッド**:
  - `login(email, password)`
  - `logout()`
  - `register(userData)`

#### CompanyContext
- **役割**: 選択中の会社情報の管理
- **状態**:
  - `currentCompany`: 現在選択中の会社
  - `companies`: ユーザーが所属する会社一覧
- **メソッド**:
  - `switchCompany(companyId)`

### 4-3. ルーティング構成

```javascript
/                           → Dashboard (認証必須)
/login                      → Login
/register                   → Register
/masters/accounts           → Accounts List (viewer以上)
/masters/accounts/new       → Account Create (accountant以上)
/masters/accounts/:id/edit  → Account Edit (accountant以上)
/journals                   → Journals List (viewer以上)
/journals/new               → Journal Create (accountant以上)
/invoices                   → Invoices List (viewer以上)
/invoices/new               → Invoice Create (accountant以上)
/reports/general-ledger     → General Ledger (viewer以上)
/reports/trial-balance      → Trial Balance (viewer以上)
/reports/profit-loss        → P/L Statement (viewer以上)
/reports/balance-sheet      → Balance Sheet (viewer以上)
/settings/fiscal-periods    → Fiscal Periods (admin)
/settings/company           → Company Settings (admin)
/settings/users             → User Management (admin)
```

### 4-4. 認証フロー

```
1. ユーザーがログイン画面でメールアドレス・パスワードを入力
2. POST /api/auth/login でバックエンドに送信
3. バックエンドが認証成功時、accessTokenとrefreshTokenを返却
4. フロントエンドがlocalStorageにトークンを保存
5. 以降のAPIリクエストにAuthorization: Bearer {accessToken}を付与
6. トークン有効期限切れ時、refreshTokenで再取得
```

---

## 5. バックエンド構成

### 5-1. レイヤー構成

Spring Bootのレイヤードアーキテクチャを採用：

```
┌─────────────────────────────────────────┐
│      Controller Layer (REST API)        │
│  - リクエストの受付・レスポンスの返却    │
│  - バリデーション                        │
│  - DTOへの変換                           │
└──────────────┬──────────────────────────┘
               │
┌──────────────┴──────────────────────────┐
│         Service Layer                   │
│  - ビジネスロジック                      │
│  - トランザクション管理                  │
│  - 複数Repositoryの調整                  │
└──────────────┬──────────────────────────┘
               │
┌──────────────┴──────────────────────────┐
│       Repository Layer (JPA)            │
│  - データベースアクセス                  │
│  - CRUD操作                              │
│  - カスタムクエリ                        │
└──────────────┬──────────────────────────┘
               │
┌──────────────┴──────────────────────────┐
│          Database (MySQL)               │
└─────────────────────────────────────────┘
```

### 5-2. パッケージ構成

```
backend/src/main/java/com/accounting/app/
├── AccountingApplication.java          # メインクラス
├── config/                             # 設定クラス
│   ├── SecurityConfig.java             # Spring Security設定
│   ├── CorsConfig.java                 # CORS設定
│   └── JpaConfig.java                  # JPA設定
├── controller/                         # Controllerレイヤー
│   ├── AuthController.java
│   ├── AccountController.java
│   ├── JournalController.java
│   ├── InvoiceController.java
│   └── ReportController.java
├── service/                            # Serviceレイヤー
│   ├── AuthService.java
│   ├── AccountService.java
│   ├── JournalService.java
│   ├── InvoiceService.java
│   └── ReportService.java
├── repository/                         # Repositoryレイヤー
│   ├── UserRepository.java
│   ├── CompanyRepository.java
│   ├── AccountRepository.java
│   ├── JournalRepository.java
│   └── InvoiceRepository.java
├── entity/                             # Entityクラス (JPA)
│   ├── User.java
│   ├── Company.java
│   ├── Account.java
│   ├── Journal.java
│   ├── JournalDetail.java
│   └── Invoice.java
├── dto/                                # DTO (Data Transfer Object)
│   ├── request/
│   │   ├── LoginRequest.java
│   │   ├── AccountCreateRequest.java
│   │   └── JournalCreateRequest.java
│   └── response/
│       ├── LoginResponse.java
│       ├── AccountResponse.java
│       └── JournalResponse.java
├── exception/                          # 例外クラス
│   ├── GlobalExceptionHandler.java     # グローバル例外ハンドラ
│   ├── ResourceNotFoundException.java
│   └── BusinessLogicException.java
├── security/                           # セキュリティ関連
│   ├── JwtTokenProvider.java           # JWT生成・検証
│   ├── JwtAuthenticationFilter.java    # JWT認証フィルタ
│   └── UserDetailsServiceImpl.java
└── util/                               # ユーティリティ
    ├── PdfGenerator.java               # PDF生成
    └── ExcelGenerator.java             # Excel生成
```

### 5-3. 主要クラスの役割

#### Controller
- HTTPリクエストを受け付ける
- リクエストパラメータのバリデーション
- DTOへの変換
- Serviceレイヤーの呼び出し
- HTTPレスポンスの返却

**例**:
```java
@RestController
@RequestMapping("/api/accounts")
public class AccountController {
    @Autowired
    private AccountService accountService;

    @GetMapping
    public ResponseEntity<ApiResponse<List<AccountResponse>>> getAccounts() {
        // Service呼び出し → DTOに変換 → レスポンス返却
    }

    @PostMapping
    public ResponseEntity<ApiResponse<AccountResponse>> createAccount(
        @Valid @RequestBody AccountCreateRequest request) {
        // バリデーション → Service呼び出し → レスポンス返却
    }
}
```

#### Service
- ビジネスロジックの実装
- トランザクション管理（@Transactional）
- 複数Repositoryの調整
- 例外ハンドリング

**例**:
```java
@Service
public class JournalService {
    @Autowired
    private JournalRepository journalRepository;

    @Autowired
    private JournalDetailRepository journalDetailRepository;

    @Transactional
    public Journal createJournal(JournalCreateRequest request) {
        // 1. ビジネスルール検証（借方=貸方）
        // 2. Journalエンティティ作成
        // 3. JournalDetailエンティティ作成
        // 4. Repository保存
        // 5. 返却
    }
}
```

#### Repository
- データベースアクセス
- Spring Data JPAによる自動CRUD実装
- カスタムクエリ（@Query）

**例**:
```java
@Repository
public interface JournalRepository extends JpaRepository<Journal, Long> {
    List<Journal> findByCompanyIdAndFiscalPeriodId(Long companyId, Long fiscalPeriodId);

    @Query("SELECT j FROM Journal j WHERE j.journalDate BETWEEN :startDate AND :endDate")
    List<Journal> findByDateRange(@Param("startDate") LocalDate startDate,
                                   @Param("endDate") LocalDate endDate);
}
```

---

## 6. データベース構成

### 6-1. テーブル一覧

全14テーブル：

**マスタテーブル（9）**:
1. `companies` - 会社マスタ
2. `users` - ユーザーマスタ
3. `user_company_roles` - ユーザー・会社・役割関連
4. `fiscal_periods` - 会計期間
5. `accounts` - 勘定科目マスタ
6. `sub_accounts` - 補助科目マスタ
7. `tax_types` - 税区分マスタ
8. `partners` - 取引先マスタ
9. `items` - 品目マスタ

**トランザクションテーブル（5）**:
10. `journals` - 仕訳ヘッダー
11. `journal_details` - 仕訳明細
12. `invoices` - 請求書ヘッダー
13. `invoice_details` - 請求明細
14. `payments` - 入金データ

### 6-2. 主要なインデックス

- **主キーインデックス**: 全テーブルの`id`カラム
- **ユニークインデックス**:
  - `companies.company_code`
  - `users.email`
  - `accounts.account_code` (会社ID + 勘定科目コード)
  - `journals.journal_no` (会社ID + 仕訳番号)
  - `invoices.invoice_no` (会社ID + 請求書番号)
- **外部キーインデックス**: 全ての外部キーカラム

### 6-3. トランザクション設計

- **分離レベル**: READ_COMMITTED
- **トランザクション境界**: Serviceレイヤーのメソッド単位
- **ロールバック**: RuntimeException発生時に自動ロールバック

### 6-4. バックアップ戦略

- **日次バックアップ**: Heroku Postgresの自動バックアップ機能を使用
- **保持期間**: 7日間

---

## 7. インフラ構成

### 7-1. Heroku構成

```
┌────────────────────────────────────────────────────┐
│                   Heroku App                       │
│                                                    │
│  ┌──────────────────────────────────────────────┐ │
│  │  Dyno (Web)                                  │ │
│  │  - フロントエンド (Nginx + React SPA)         │ │
│  │  - ポート: 3000                               │ │
│  └──────────────────────────────────────────────┘ │
│                                                    │
│  ┌──────────────────────────────────────────────┐ │
│  │  Dyno (Web)                                  │ │
│  │  - バックエンド (Spring Boot)                 │ │
│  │  - ポート: 8080                               │ │
│  └──────────────────────────────────────────────┘ │
│                                                    │
│  ┌──────────────────────────────────────────────┐ │
│  │  Add-on: JawsDB MySQL                        │ │
│  │  - MySQL 8.0                                 │ │
│  │  - ストレージ: 5GB (無料プラン)               │ │
│  └──────────────────────────────────────────────┘ │
│                                                    │
└────────────────────────────────────────────────────┘
```

### 7-2. 環境変数

| 変数名 | 説明 | 例 |
|-------|------|-----|
| `DATABASE_URL` | MySQL接続URL | jdbc:mysql://host:port/db |
| `DB_USER` | DB接続ユーザー | root |
| `DB_PASSWORD` | DB接続パスワード | - |
| `JWT_SECRET` | JWT署名用シークレット | - |
| `CORS_ALLOWED_ORIGINS` | CORS許可オリジン | http://localhost:3000 |

### 7-3. スケーリング戦略

- **水平スケーリング**: Dynoの数を増やす（有料プラン）
- **垂直スケーリング**: Dynoのサイズを大きくする（有料プラン）

---

## 8. セキュリティ設計

### 8-1. 認証・認可

**認証方式**: JWT (JSON Web Token)

**フロー**:
1. ユーザーがメールアドレス・パスワードでログイン
2. バックエンドが認証成功時、JWTトークンを発行
3. フロントエンドがトークンをlocalStorageに保存
4. 以降のAPIリクエストに`Authorization: Bearer {token}`を付与
5. バックエンドがトークンを検証し、権限チェック

**権限レベル**:
- `admin`: 全操作可能
- `accountant`: 仕訳・レポート・マスタ管理可能
- `viewer`: 参照のみ可能

### 8-2. セキュリティ対策

| 脅威 | 対策 |
|------|------|
| **SQLインジェクション** | Spring Data JPAのパラメータバインディング使用 |
| **XSS** | Reactのエスケープによる自動防御 |
| **CSRF** | JWTトークン認証（ステートレス）により不要 |
| **認証情報の保護** | パスワードはbcryptでハッシュ化して保存 |
| **通信の暗号化** | HTTPS通信の強制 |
| **機密情報の漏洩** | 環境変数で管理、コードにハードコーディングしない |

### 8-3. バリデーション

**フロントエンド**:
- HTML5バリデーション
- JavaScript バリデーション（リアルタイム）

**バックエンド**:
- Bean Validation (@Valid, @NotNull, @Size等)
- カスタムバリデーション（ビジネスルール）

---

## 9. CI/CD設計

### 9-1. GitHub Actions ワークフロー

```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # バックエンドテスト
  backend-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'
      - name: Run tests
        run: cd backend && mvn test

  # フロントエンドテスト
  frontend-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '18'
      - name: Install dependencies
        run: cd frontend && npm install
      - name: Run tests
        run: cd frontend && npm test

  # Herokuデプロイ (mainブランチのみ)
  deploy:
    needs: [backend-test, frontend-test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v2
      - name: Deploy to Heroku
        uses: akhileshns/heroku-deploy@v3.12.12
        with:
          heroku_api_key: ${{secrets.HEROKU_API_KEY}}
          heroku_app_name: "accounting-app"
          heroku_email: ${{secrets.HEROKU_EMAIL}}
```

### 9-2. デプロイフロー

```
1. 開発者がコードをGitHubにpush
2. GitHub Actionsが自動的にテスト実行
3. テスト成功時、mainブランチなら自動的にHerokuにデプロイ
4. Herokuがビルド・起動
5. デプロイ完了
```

---

## 10. 開発環境

### 10-1. Docker Compose構成

ローカル開発環境はDocker Composeで構築：

```yaml
services:
  db:
    image: mysql:8.0
    environment:
      MYSQL_DATABASE: accounting_db
      MYSQL_ROOT_PASSWORD: rootpassword
    ports:
      - "3306:3306"

  backend:
    build: ./backend
    ports:
      - "8080:8080"
    environment:
      DB_HOST: db
      DB_PORT: 3306
    depends_on:
      - db

  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    depends_on:
      - backend
```

### 10-2. 開発ツール

| ツール | 用途 |
|-------|------|
| **IntelliJ IDEA** | Java開発IDE |
| **VS Code** | フロントエンド開発エディタ |
| **DBeaver** | データベース管理ツール |
| **Postman** | API動作確認ツール |
| **Git** | バージョン管理 |

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-11-28 | 1.0 | 初版作成 |
